<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تم تأكيد الحجز - جامعة نجران</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="success-page">
    <script>
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.classList.add('dark-mode');
        }
    </script>

    <!-- الهيدر -->
    <header class="simple-header">
        <div class="header-content">
            <img src="assets/images/university-logo.png" alt="شعار جامعة نجران" class="logo">
            <h1>تم تأكيد حجز السكن الجامعي</h1>
            <p>مبروك! لقد تم حفظ بياناتك في الخزنة الآمنة</p>
        </div>
    </header>

    <main class="success-container">
        <div class="container">
            <!-- بطاقة التأكيد الرئيسية -->
            <div class="success-card">
                <div class="success-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                
                <h2>تم تأكيد حجز سكنك الجامعي بنجاح!</h2>
                <p class="success-message">
                    تمت عملية حجز السكن الجامعي بنجاح وتم تخزين جميع بياناتك في الخزنة الآمنة التابعة لعمادة شؤون الطلاب.
                </p>
                
                <!-- رقم الحجز -->
                <div class="reservation-number">
                    <h3>رقم حجزك هو:</h3>
                    <div class="reservation-code" id="reservationCode">
                        <!-- سيتم توليده بواسطة JavaScript -->
                    </div>
                    <p class="reservation-hint">احفظ هذا الرقم للمراجعة والمتابعة</p>
                </div>
                
                <!-- تفاصيل الحجز -->
                <div class="reservation-details">
                    <h3><i class="fas fa-info-circle"></i> تفاصيل حجزك</h3>
                    <div class="details-grid">
                        <div class="detail-item">
                            <span class="detail-label">اسم الطالب:</span>
                            <span class="detail-value" id="studentName">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">رقم الهوية:</span>
                            <span class="detail-value" id="studentId">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">المبنى المختار:</span>
                            <span class="detail-value" id="buildingName">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">تاريخ الحجز:</span>
                            <span class="detail-value" id="reservationDate">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">الحالة:</span>
                            <span class="detail-value status-confirmed">مؤكد</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">أولوية الحجز:</span>
                            <span class="detail-value" id="priorityLevel">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- رسالة تأكيد -->
                <div class="confirmation-message">
                    <div class="message-icon">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div class="message-content">
                        <h4>سيصلك تأكيد عبر الرسائل النصية والبريد الإلكتروني</h4>
                        <p>تم إرسال رسالة تأكيد إلى بريدك الإلكتروني ورقم جوالك المسجل يحتوي على جميع التفاصيل.</p>
                        <p id="contactInfo" class="contact-info"></p>
                    </div>
                </div>
                
                <!-- الخزنة -->
                <div class="vault-notice">
                    <div class="vault-icon">
                        <i class="fas fa-database"></i>
                    </div>
                    <div class="vault-content">
                        <h4><i class="fas fa-shield-alt"></i> تم حفظ بياناتك في الخزنة الآمنة</h4>
                        <p>جميع بياناتك الشخصية والأكاديمية محفوظة في قاعدة البيانات الآمنة التابعة للجامعة.</p>
                        <p class="vault-status">
                            <i class="fas fa-check"></i> 
                            <span id="vaultStatus">جاري حفظ البيانات في الخزنة...</span>
                        </p>
                    </div>
                </div>
                
                <!-- أزرار الإجراءات -->
                <div class="success-actions">
                    <button id="printConfirmation" class="btn-primary">
                        <i class="fas fa-print"></i> طباعة تأكيد الحجز
                    </button>
                    <button id="sendToEmail" class="btn-secondary">
                        <i class="fas fa-paper-plane"></i> إرسال إلى البريد الإلكتروني
                    </button>
                    <a href="index.html" class="btn-tertiary">
                        <i class="fas fa-home"></i> العودة إلى الصفحة الرئيسية
                    </a>
                </div>
                
                <!-- معلومات هامة -->
                <div class="important-notice">
                    <h4><i class="fas fa-exclamation-triangle"></i> معلومات هامة للطالب</h4>
                    <ul>
                        <li>يجب الحضور إلى إدارة السكن خلال أسبوع من بداية الفصل الدراسي</li>
                        <li>يرجى إحضار نسخة من الهوية الوطنية وبطاقة الطالب</li>
                        <li>لأي استفسار، يمكنك الاتصال على الرقم: 0175432100</li>
                        <li>يمكنك متابعة حالة حجزك عبر نظام الخزنة الإلكتروني</li>
                    </ul>
                </div>
            </div>
            
            <!-- QR Code لرقم الحجز -->
            <div class="qr-section">
                <div class="qr-card">
                    <h3><i class="fas fa-qrcode"></i> باركود الحجز</h3>
                    <div class="qr-code" id="qrCode">
                        <!-- سيتم توليد QR Code هنا -->
                        <div class="qr-placeholder">
                            <i class="fas fa-qrcode"></i>
                            <p>QR Code</p>
                        </div>
                    </div>
                    <p class="qr-info">يمكن مسح هذا الباركود عند الوصول إلى السكن</p>
                </div>
                
                <!-- تتبع المراحل -->
                <div class="timeline-card">
                    <h3><i class="fas fa-project-diagram"></i> مراحل تقدم طلبك</h3>
                    <div class="timeline">
                        <div class="timeline-step completed">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <h4>التسجيل</h4>
                                <p>تم بنجاح</p>
                            </div>
                        </div>
                        <div class="timeline-step completed">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <h4>اختيار المبنى</h4>
                                <p>تم بنجاح</p>
                            </div>
                        </div>
                        <div class="timeline-step active">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <h4>تأكيد الحجز</h4>
                                <p>جاري الآن</p>
                            </div>
                        </div>
                        <div class="timeline-step">
                            <div class="step-number">4</div>
                            <div class="step-content">
                                <h4>الاستلام</h4>
                                <p>عند الوصول</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- الفوتر -->
    <footer class="success-footer">
        <div class="footer-content">
            <p>
                <i class="fas fa-university"></i>
                جامعة نجران - عمادة شؤون الطلاب - إدارة السكن الطلابي
            </p>
            <p>
                <i class="fas fa-phone"></i> الدعم الفني: 0175432100 | 
                <i class="fas fa-envelope"></i> البريد: housing@nu.edu.sa
            </p>
            <div class="security-badges">
                <img src="assets/images/ncsc.png" alt="NCSC">
                <img src="assets/images/vision2030.png" alt="رؤية 2030">
            </div>
        </div>
    </footer>

    <script src="js/main.js"></script>
    <script src="js/vault.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // الحصول على بيانات الطالب
            const studentData = JSON.parse(localStorage.getItem('currentStudent'));
            
            if (!studentData) {
                alert('لا توجد بيانات حجز! الرجاء البدء من الصفحة الرئيسية');
                window.location.href = 'index.html';
                return;
            }
            
            // توليد رقم حجز فريد
            const reservationCode = generateReservationCode(studentData.nationalId);
            document.getElementById('reservationCode').textContent = reservationCode;
            
            // ملء تفاصيل الحجز
            document.getElementById('studentName').textContent = studentData.fullName;
            document.getElementById('studentId').textContent = studentData.nationalId;
            document.getElementById('buildingName').textContent = studentData.buildingName || 'المبنى أ';
            document.getElementById('reservationDate').textContent = new Date().toLocaleDateString('ar-SA');
            document.getElementById('contactInfo').textContent = `${studentData.phone} | ${studentData.email}`;
            
            // حساب الأولوية
            const priorityScore = calculatePriorityScore(studentData.gpa, studentData.province);
            let priorityLevel = 'عادية';
            if (priorityScore >= 80) priorityLevel = 'عالية';
            else if (priorityScore >= 60) priorityLevel = 'متوسطة';
            document.getElementById('priorityLevel').textContent = priorityLevel;
            
            // حفظ البيانات في الخزنة
            setTimeout(() => {
                saveToVault(studentData, reservationCode);
            }, 1000);
            
            // طباعة التأكيد
            document.getElementById('printConfirmation').addEventListener('click', function() {
                window.print();
            });
            
            // إرسال إلى البريد
            document.getElementById('sendToEmail').addEventListener('click', function() {
                alert(`سيتم إرسال تأكيد الحجز إلى ${studentData.email}`);
                // في الواقع، هنا سيتم إرسال رسالة حقيقية
            });
            
            // توليد QR Code (محاكاة)
            setTimeout(() => {
                document.querySelector('.qr-placeholder').innerHTML = `
                    <div class="qr-generated">
                        <div class="qr-lines"></div>
                        <div class="qr-text">${reservationCode}</div>
                    </div>
                `;
            }, 1500);
        });
        
        function generateReservationCode(nationalId) {
            const timestamp = Date.now().toString().slice(-6);
            const idPart = nationalId.slice(-4);
            const randomPart = Math.floor(1000 + Math.random() * 9000);
            return `NU-HS-${idPart}-${timestamp}-${randomPart}`;
        }
        
        function calculatePriorityScore(gpa, province) {
            const distanceMap = {
                'نجران': 0,
                'الرياض': 85,
                'مكة المكرمة': 90,
                'المدينة المنورة': 88,
                'الشرقية': 95,
                'عسير': 30,
                'جازان': 65,
                'حائل': 75,
                'القصيم': 70,
                'تبوك': 80,
                'الجوف': 82,
                'الباحة': 40,
                'الحدود الشمالية': 89
            };
            
            const gpaScore = (gpa / 5) * 70;
            const distanceScore = (distanceMap[province] || 50) * 0.3;
            return Math.min(100, Math.round(gpaScore + distanceScore));
        }
        
        function saveToVault(studentData, reservationCode) {
            try {
                const vault = new StudentVault();
                
                const completeData = {
                    ...studentData,
                    reservationCode,
                    reservationDate: new Date().toISOString(),
                    status: 'confirmed',
                    priorityScore: calculatePriorityScore(studentData.gpa, studentData.province)
                };
                
                vault.addStudent(completeData);
                
                document.getElementById('vaultStatus').innerHTML = `
                    <span style="color: #2e8b57;">
                        <i class="fas fa-check-circle"></i> تم حفظ البيانات في الخزنة بنجاح
                    </span>
                `;
                
                // تحديث العداد في الصفحة الرئيسية
                localStorage.setItem('lastReservation', JSON.stringify({
                    code: reservationCode,
                    time: new Date().toISOString()
                }));
                
            } catch (error) {
                document.getElementById('vaultStatus').innerHTML = `
                    <span style="color: #dc3545;">
                        <i class="fas fa-exclamation-circle"></i> حدث خطأ في الحفظ، الرجاء الاتصال بالدعم الفني
                    </span>
                `;
                console.error('Error saving to vault:', error);
            }
        }
    </script>
</body>
</html>
